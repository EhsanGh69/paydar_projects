{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}


{% block title %}
    {% if request.resolver_match.url_name == 'use_certificate_create' %}
        ثبت گواهی مصرف 
    {% else %}
        ویرایش گواهی مصرف
    {% endif %} 
{% endblock %}

{% block link %}

<link rel="stylesheet" href="{% static 'jalali_date_picker/jalalidatepicker.min.css' %}">

{% endblock %}


{% block page_title %}
    {% if request.resolver_match.url_name == 'use_certificate_create' %}
        <span>ثبت گواهی مصرف</span>
    {% else %}
        <span>ویرایش گواهی مصرف</span>
    {% endif %}
{% endblock %}



{% block main %}

<div class="card card-primary p-5">

    <div class="card-body col-12 col-lg-8 offset-lg-2">

      <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <p>
                <i class="text-info">پر کردن موارد ستاره‌دار الزامی می‌باشد</i>
            </p>

            {% if form.non_field_errors %}
                {% for error in form.non_field_errors %}
                    <div class="alert alert-danger">
                        <h5>
                            <i class="fa-solid fa-circle-xmark"></i>
                            <span>{{ error }}</span>
                        </h5>
                    </div>
                {% endfor %}
            {% endif %}

            <div class="row">

                <fieldset class="input-group border-bottom mb-3">
                    <legend class="mb-3">
                        <i class="bg-info text-light p-1 rounded" style="font-size: 1.2rem;">کالا</i>
                    </legend>
                    <div class="col-12 col-xl-6 mb-3">
                        {{ form.stuff_type|as_crispy_field }}
                    </div>
                    <div class="col-12 col-xl-6 mb-3">
                        {{ form.measurement_unit|as_crispy_field }}
                    </div>
                    <div class="col-12 col-xl-6 mb-3">
                        {{ form.is_deficient|as_crispy_field }}
                    </div>
                    <div class="col-12 col-xl-6 mb-3">
                        {{ form.deficient_amount|as_crispy_field }}
                        <span class="text-danger d-none" id="deficient_alert">لطفا مقدار کسری را وارد نمایید</span>
                    </div>
                    <div class="col-12 col-xl-6 mb-3">
                        {{ form.is_excess|as_crispy_field }}
                    </div>
                    <div class="col-12 col-xl-6 mb-3">
                        {{ form.excess_amount|as_crispy_field }}
                        <span class="text-danger d-none" id="excess_alert">لطفا مقدار مازاد را وارد نمایید</span>
                    </div>
                    <div class="col-12 col-xl-6 mb-3">
                        <label>{{ form.start_using_date.label }}*</label>
                        {% if form.start_using_date.errors %}
                        {{ form.start_using_date|add_class:"form-control border border-danger"|attr:"data-jdp"|attr:"placeholder:برای انتخاب تاریخ کلیک کنید"|attr:"autocomplete:off" }}
                            {% for error in form.start_using_date.errors %}
                                <p class="text-danger">
                                    <strong>{{ error }}</strong>
                                </p>
                            {% endfor %}
                        {% else %}
                            {{ form.start_using_date|add_class:"form-control"|attr:"data-jdp"|attr:"placeholder:برای انتخاب تاریخ کلیک کنید"|attr:"autocomplete:off" }}
                        {% endif %}
                    </div>
                    <div class="col-12 col-xl-6 mb-3">
                        <label>{{ form.finish_using_date.label }}*</label>
                        {% if form.finish_using_date.errors %}
                        {{ form.finish_using_date|add_class:"form-control border border-danger"|attr:"data-jdp"|attr:"placeholder:برای انتخاب تاریخ کلیک کنید"|attr:"autocomplete:off" }}
                            {% for error in form.finish_using_date.errors %}
                                <p class="text-danger">
                                    <strong>{{ error }}</strong>
                                </p>
                            {% endfor %}
                        {% else %}
                            {{ form.finish_using_date|add_class:"form-control"|attr:"data-jdp"|attr:"placeholder:برای انتخاب تاریخ کلیک کنید"|attr:"autocomplete:off" }}
                        {% endif %}
                    </div>
                    
                </fieldset>

                <fieldset class="input-group border-bottom mb-3">
                    <legend class="mb-3">
                        <i class="bg-info text-light p-1 rounded" style="font-size: 1.2rem;">مرجوعی</i>
                    </legend>
                    <div class="col-12 col-xl-6 mb-3">
                        {{ form.returned_to|as_crispy_field }}
                    </div>
                    <div class="col-12 col-xl-6 mb-3">
                        <label>{{ form.return_date.label }}</label>

                        {% if form.return_date.errors %}
                        {{ form.return_date|add_class:"form-control border border-danger"|attr:"data-jdp"|attr:"placeholder:برای انتخاب تاریخ کلیک کنید"|attr:"autocomplete:off" }}
                            {% for error in form.return_date.errors %}
                                <p class="text-danger">
                                    <strong>{{ error }}</strong>
                                </p>
                            {% endfor %}
                        {% else %}
                            {{ form.return_date|add_class:"form-control"|attr:"data-jdp"|attr:"placeholder:برای انتخاب تاریخ کلیک کنید"|attr:"autocomplete:off" }}
                        {% endif %}
                    </div>
                    <span class="text-danger d-none" id="return_alert">لطفا انبار و تاریخ ارجاع کالا را انتخاب نمایید</span>
                    
                </fieldset>
                
            </div>

            <div class="row">
                <div class="col-8 col-sm-6 col-xl-4 my-4">
                    <button class="btn btn-success btn-block" type="submit" id="submit-btn">
                        {% if request.resolver_match.url_name == 'use_certificate_create' %}
                            <span>ثبت گواهی مصرف</span>
                        {% else %}
                            <span>ویرایش گواهی مصرف</span>
                        {% endif %}
                    </button>
                </div>
            </div>
      </form>

    </div>

  </div>

{% endblock  %}


{% block scripts %}

<script src="{% static 'jalali_date_picker/jalalidatepicker.min.js' %}"></script>

<script>
    $(document).ready(function () {
       
        jalaliDatepicker.startWatch({ 
            time: false
        });

        $("#id_deficient_amount").attr("disabled","disabled");
        $("#id_excess_amount").attr("disabled","disabled");
        $("#id_returned_to").attr("disabled","disabled");
        $("#id_return_date").attr("disabled","disabled");

        $('#id_is_deficient').change(function (e) { 
            e.preventDefault();
            if(this.checked){
                $("#deficient_alert").removeClass("d-none");
                $("#id_deficient_amount").removeAttr("disabled");
                $("#submit-btn").attr("type","button");
            }else{
                $("#deficient_alert").addClass("d-none");
                $("#id_deficient_amount").attr("disabled","disabled");
                $("#submit-btn").attr("type","submit");
            }
        });

        $('#id_deficient_amount').change(function (e) { 
            e.preventDefault();
            $("#deficient_alert").addClass("d-none");
            $("#submit-btn").attr("type","submit");
        });

        $('#id_is_excess').change(function (e) { 
            e.preventDefault();
            if(this.checked){
                $("#excess_alert").removeClass("d-none");
                $("#return_alert").removeClass("d-none");
                $("#id_excess_amount").removeAttr("disabled");
                $("#id_returned_to").removeAttr("disabled");
                $("#id_return_date").removeAttr("disabled");
                $("#submit-btn").attr("type","button");
            }else{
                $("#excess_alert").addClass("d-none");
                $("#return_alert").addClass("d-none");
                $("#id_excess_amount").attr("disabled","disabled");
                $("#id_returned_to").attr("disabled","disabled");
                $("#id_return_date").attr("disabled","disabled");
                $("#submit-btn").attr("type","submit");
            }
        });

        $('#id_excess_amount,#id_returned_to,#id_return_date').change(function (e) { 
            e.preventDefault();
            $("#excess_alert").addClass("d-none");
            $("#return_alert").addClass("d-none");
            $("#submit-btn").attr("type","submit");
        });
       
        $('#id_start_using_date').on('input', function (e) { 
            e.preventDefault();
            var date_value = $('#id_start_using_date').val();

            $('#id_start_using_date').val(date_value.replaceAll('/', '-'));
        });

        $('#id_finish_using_date').on('input', function (e) { 
            e.preventDefault();
            var date_value = $('#id_finish_using_date').val();

            $('#id_finish_using_date').val(date_value.replaceAll('/', '-'));
        });

        $('#id_return_date').on('input', function (e) { 
            e.preventDefault();
            var date_value = $('#id_return_date').val();

            $('#id_return_date').val(date_value.replaceAll('/', '-'));
        });

        
   });

</script>

{% endblock %}

